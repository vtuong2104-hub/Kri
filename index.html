<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ketnoi090 - Smart Connect</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #000; --primary: #00d2ff; --card: #1a1a1a; --accent: #ffcc00; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* Popup th√¥ng b√°o m√£ cho ng∆∞·ªùi ƒë·∫ßu ti√™n */
        #code-popup { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .popup-card { background: var(--card); padding: 30px; border-radius: 20px; text-align: center; border: 2px solid var(--primary); width: 100%; max-width: 320px; }
        .id-value { background: #000; padding: 15px; border-radius: 10px; font-family: monospace; font-size: 18px; color: var(--primary); margin: 15px 0; border: 1px dashed #555; word-break: break-all; }

        /* M√†n h√¨nh ch·ªù nh·∫≠p t√™n */
        #overlay { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: var(--card); padding: 25px; border-radius: 20px; width: 100%; max-width: 300px; text-align: center; border: 1px solid #333; }
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #000; color: white; box-sizing: border-box; text-align: center; }

        /* M√†n h√¨nh cho ng∆∞·ªùi v√†o sau (Nh·∫≠p m√£ k·∫øt n·ªëi) */
        #join-screen { position: fixed; inset: 0; background: var(--bg); z-index: 1500; display: none; align-items: center; justify-content: center; padding: 20px; }
        .join-card { background: var(--card); padding: 25px; border-radius: 20px; width: 100%; max-width: 300px; text-align: center; border: 1px solid var(--accent); }

        /* Layout Video & Chat */
        #video-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; padding: 4px; background: #080808; max-height: 25vh; }
        .v-box { position: relative; background: #222; border-radius: 8px; overflow: hidden; height: 110px; border: 1px solid #333; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #121212; border-top: 1px solid #333; }
        .msg { padding: 10px 14px; border-radius: 18px; max-width: 80%; font-size: 14px; }
        .msg-me { background: #0084ff; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg-remote { background: #333; align-self: flex-start; border-bottom-left-radius: 4px; }

        #input-bar { padding: 10px; display: flex; gap: 8px; background: #1a1a1a; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        #msg-in { flex: 1; padding: 10px 15px; border-radius: 20px; border: none; background: #333; color: white; outline: none; }
        
        button { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: black; }
        .btn-accent { background: var(--accent); color: black; }
    </style>
</head>
<body>

<div id="code-popup">
    <div class="popup-card">
        <h3 style="margin:0">M√É B·∫†N B√à</h3>
        <p style="font-size:12px; color:#aaa">G·ª≠i m√£ n√†y cho b·∫°n b√® ƒë·ªÉ k·∫øt n·ªëi</p>
        <div class="id-value" id="my-id-text">ƒêang l·∫•y m√£...</div>
        <button class="btn-primary" style="width:100%" onclick="copyId()">COPY M√É & B·∫ÆT ƒê·∫¶U</button>
    </div>
</div>

<div id="overlay">
    <div class="login-card">
        <h2 style="color:var(--primary); margin:0 0 15px 0;">KETNOI090</h2>
        <input type="text" id="user-name" placeholder="T√™n c·ªßa b·∫°n...">
        <button class="btn-primary" style="width:100%" onclick="checkRole()">TI·∫æP T·ª§C</button>
    </div>
</div>

<div id="join-screen">
    <div class="join-card">
        <h3 style="margin:0">K·∫æT N·ªêI B·∫†N B√à</h3>
        <p style="font-size:12px; color:#aaa">D√°n m√£ b·∫°n b√® ƒë√£ g·ª≠i v√†o ƒë√¢y</p>
        <input type="text" id="partner-id-in" placeholder="Nh·∫≠p m√£ t·∫°i ƒë√¢y..." 
               style="width:100%; padding:12px; margin:15px 0; border-radius:8px; border:1px solid #444; background:#000; color:white; text-align:center;">
        <button class="btn-accent" style="width:100%" onclick="connectToFriend()">K·∫æT N·ªêI NGAY</button>
        <p style="font-size:10px; margin-top:10px; color:#555" onclick="showPopupManual()">T√¥i l√† ng∆∞·ªùi t·∫°o ph√≤ng</p>
    </div>
</div>

<div id="video-grid">
    <div class="v-box">
        <video id="local-video" autoplay muted playsinline style="transform: scaleX(-1);"></video>
        <div style="position:absolute; bottom:5px; left:5px; font-size:10px; background:rgba(0,0,0,0.5); padding:2px 5px;">T√¥i</div>
    </div>
</div>

<div id="chat-box"></div>

<div id="input-bar">
    <input type="text" id="msg-in" placeholder="Nh·∫Øn tin..." onkeypress="if(event.key==='Enter') sendText()">
    <button onclick="sendText()" style="background:var(--primary); border-radius:50%; width:40px; height:40px;">üöÄ</button>
</div>

<script>
    let peer, localStream, myName;
    let connections = {};

    async function checkRole() {
        myName = document.getElementById('user-name').value.trim();
        if(!myName) return alert("Nh·∫≠p t√™n!");

        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true }).catch(() => {
            alert("L·ªói! C·∫ßn Camera ƒë·ªÉ ho·∫°t ƒë·ªông."); return null;
        });
        if(!localStream) return;
        document.getElementById('local-video').srcObject = localStream;
        document.getElementById('overlay').style.display = 'none';

        // Kh·ªüi t·∫°o Peer
        peer = new Peer();
        peer.on('open', (id) => {
            document.getElementById('my-id-text').innerText = id;
            // Hi·ªÉn th·ªã m√†n h√¨nh nh·∫≠p m√£ cho ng∆∞·ªùi v√†o sau
            document.getElementById('join-screen').style.display = 'flex';
        });

        peer.on('call', (call) => {
            call.answer(localStream);
            setupVideo(call);
        });
        peer.on('connection', setupData);
    }

    function showPopupManual() {
        document.getElementById('join-screen').style.display = 'none';
        document.getElementById('code-popup').style.display = 'flex';
    }

    function copyId() {
        const id = document.getElementById('my-id-text').innerText;
        navigator.clipboard.writeText(id);
        alert("ƒê√£ copy m√£! H√£y g·ª≠i cho b·∫°n b√®.");
        document.getElementById('code-popup').style.display = 'none';
    }

    function connectToFriend() {
        const pId = document.getElementById('partner-id-in').value.trim();
        if(!pId) return alert("Vui l√≤ng d√°n m√£ b·∫°n b√®!");
        
        setupData(peer.connect(pId));
        setupVideo(peer.call(pId, localStream));
        document.getElementById('join-screen').style.display = 'none';
    }

    function setupData(conn) {
        conn.on('open', () => {
            connections[conn.peer] = conn;
            addMsg("K·∫øt n·ªëi th√†nh c√¥ng!", "remote", "H·ªá th·ªëng");
            conn.on('data', (data) => {
                if(data.type === 'text') addMsg(data.content, 'remote', data.name);
            });
        });
    }

    function setupVideo(call) {
        call.on('stream', (stream) => {
            if (document.getElementById('v-' + call.peer)) return;
            const box = document.createElement('div');
            box.className = 'v-box'; box.id = 'v-' + call.peer;
            const v = document.createElement('video');
            v.srcObject = stream; v.autoplay = true; v.playsInline = true;
            box.appendChild(v);
            document.getElementById('video-grid').appendChild(box);
            document.getElementById('join-screen').style.display = 'none';
            document.getElementById('code-popup').style.display = 'none';
        });
    }

    function sendText() {
        const input = document.getElementById('msg-in');
        if(input.value.trim()) {
            Object.values(connections).forEach(c => c.send({ type: 'text', content: input.value, name: myName }));
            addMsg(input.value, 'me', myName);
            input.value = '';
        }
    }

    function addMsg(txt, side, name) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `msg msg-${side}`;
        div.innerHTML = `<small style="display:block; font-size:10px; opacity:0.6">${name}</small>${txt}`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }
</script>
</body>
</html>
