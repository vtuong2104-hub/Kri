<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ketnoi090 - P2P Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0f0f0f; --primary: #00d2ff; --me: #0084ff; --host: #ffcc00; --card: #1e1e1e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* M√†n h√¨nh ch·ªù - C·ª±c k·ª≥ nh·ªè g·ªçn */
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: var(--card); padding: 30px 25px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; gap: 15px; width: 100%; max-width: 320px; border: 1px solid #333; }
        .login-card h2 { margin: 0; color: var(--primary); font-size: 20px; letter-spacing: 1px; }
        #online-counter { font-size: 13px; color: #00ff88; background: rgba(0,255,136,0.1); padding: 4px 12px; border-radius: 20px; }
        .login-card input { padding: 12px; border-radius: 10px; border: 1px solid #444; background: #111; color: white; width: 100%; box-sizing: border-box; text-align: center; font-size: 15px; outline: none; }
        .btn-join { width: 100%; padding: 12px; border-radius: 10px; border: none; background: var(--primary); color: black; font-weight: bold; cursor: pointer; font-size: 15px; }

        /* Video Layout - C√°ch l·ªÅ ƒë·ªÉ kh√¥ng s√°t vi·ªÅn */
        .grid-section { padding: 10px; display: grid; gap: 10px; }
        #top-videos { flex: 1; grid-template-columns: repeat(3, 1fr); }
        #bottom-videos { flex: 1; grid-template-columns: 1fr 1fr; border-top: 1px solid #222; }
        
        .v-container { position: relative; background: #000; border-radius: 12px; overflow: hidden; border: 1px solid #333; height: 100%; min-height: 120px; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .tag { position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); padding: 3px 8px; border-radius: 5px; font-size: 11px; }
        .host-tag { background: var(--host) !important; color: black; font-weight: bold; }

        /* Chat Box */
        #chat-box { flex: 2; overflow-y: auto; padding: 15px; background: #0f0f0f; display: flex; flex-direction: column; gap: 8px; margin: 0 10px; }
        .msg-row { display: flex; width: 100%; }
        .row-me { justify-content: flex-end; }
        .row-remote { justify-content: flex-start; }
        .msg { padding: 8px 12px; border-radius: 15px; max-width: 75%; font-size: 14px; }
        .msg-me { background: var(--me); border-bottom-right-radius: 2px; }
        .msg-remote { background: #333; border-bottom-left-radius: 2px; }
        .msg img { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; }
        .u-name { font-size: 10px; color: #888; margin-bottom: 2px; display: block; }

        /* Input area */
        #input-bar { padding: 12px; display: flex; gap: 10px; background: #151515; align-items: center; border-top: 1px solid #222; margin-bottom: 5px; }
        #msg-input { flex: 1; padding: 10px 15px; border-radius: 20px; border: none; background: #252525; color: white; outline: none; }
    </style>
</head>
<body>

<div id="overlay">
    <div class="login-card">
        <h2>KETNOI090</h2>
        <div id="online-counter">ƒêang ki·ªÉm tra...</div>
        <input type="text" id="user-name" placeholder="T√™n c·ªßa b·∫°n">
        <button class="btn-join" onclick="startApp()">THAM GIA</button>
    </div>
</div>

<div id="top-videos" class="grid-section"></div>
<div id="chat-box"></div>
<div id="input-bar">
    <input type="file" id="file-input" hidden accept="image/*" onchange="sendFile(this)">
    <button onclick="document.getElementById('file-input').click()" style="background:none; border:none; cursor:pointer; font-size: 20px;">üì∑</button>
    <input type="text" id="msg-input" placeholder="Tin nh·∫Øn..." onkeypress="if(event.key==='Enter') sendText()">
    <button onclick="sendText()" style="background:var(--primary); border:none; border-radius:50%; width:36px; height:36px; cursor:pointer; color:black;">üöÄ</button>
</div>
<div id="bottom-videos" class="grid-section">
    <div class="v-container">
        <video id="local-video" autoplay muted playsinline style="transform: scaleX(-1);"></video>
        <div class="tag" id="my-tag">T√¥i</div>
    </div>
</div>

<script>
    let peer, localStream, myName, isHost = false;
    let connections = {};
    const ROOM_ID = "Ketnoi090_P2P_Final";

    // M√¥ ph·ªèng s·ªë ng∆∞·ªùi online t·∫°i m√†n h√¨nh ch·ªù
    function updatePreviewCount() {
        const count = Object.keys(connections).length + 1;
        document.getElementById('online-counter').innerText = `‚óè ${count}/5 Online`;
    }
    setInterval(updatePreviewCount, 2000);

    async function startApp() {
        myName = document.getElementById('user-name').value.trim();
        if(!myName) return alert("Vui l√≤ng nh·∫≠p t√™n!");

        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('local-video').srcObject = localStream;
        } catch (e) {
            alert("Kh√¥ng th·ªÉ m·ªü Camera. H√£y d√πng HTTPS!");
            return;
        }

        document.getElementById('overlay').style.display = 'none';
        peer = new Peer(ROOM_ID);

        peer.on('open', () => {
            isHost = true;
            document.getElementById('my-tag').innerText = myName + " (Ch·ªß ph√≤ng)";
            document.getElementById('my-tag').classList.add('host-tag');
        });

        peer.on('error', (err) => {
            if (err.type === 'id-taken') {
                peer = new Peer();
                peer.on('open', () => {
                    setupData(peer.connect(ROOM_ID));
                    setupVideo(peer.call(ROOM_ID, localStream));
                });
            }
        });

        peer.on('connection', setupData);
        peer.on('call', (call) => {
            call.answer(localStream);
            setupVideo(call);
        });
    }

    function setupData(conn) {
        conn.on('open', () => {
            connections[conn.peer] = conn;
            conn.send({ type: 'intro', name: myName, isHost: isHost });
            conn.on('data', (data) => {
                if(data.type === 'intro') {
                    connections[conn.peer].remoteName = data.name;
                    connections[conn.peer].remoteIsHost = data.isHost;
                }
                if(data.type === 'text') addMsg(data.content, 'remote', connections[conn.peer].remoteName);
                if(data.type === 'file') addFile(data, 'remote', connections[conn.peer].remoteName);
            });
        });
        conn.on('close', () => {
            document.getElementById('box-' + conn.peer)?.remove();
            delete connections[conn.peer];
        });
    }

    function setupVideo(call) {
        call.on('stream', (stream) => {
            if (document.getElementById('video-' + call.peer)) return;
            const container = document.createElement('div');
            container.className = 'v-container';
            container.id = 'box-' + call.peer;
            const video = document.createElement('video');
            video.id = 'video-' + call.peer;
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            const tag = document.createElement('div');
            tag.className = 'tag';
            
            setTimeout(() => {
                const info = connections[call.peer];
                tag.innerText = (info?.remoteName || "B·∫°n b√®") + (info?.remoteIsHost ? " (Ch·ªß ph√≤ng)" : "");
                if(info?.remoteIsHost) tag.classList.add('host-tag');
            }, 1500);

            container.appendChild(video);
            container.appendChild(tag);
            const top = document.getElementById('top-videos');
            const bottom = document.getElementById('bottom-videos');
            if (top.children.length < 3) top.appendChild(container);
            else bottom.appendChild(container);
        });
    }

    function sendText() {
        const input = document.getElementById('msg-input');
        if (input.value.trim()) {
            Object.values(connections).forEach(c => c.send({ type: 'text', content: input.value }));
            addMsg(input.value, 'me', myName);
            input.value = '';
        }
    }

    function sendFile(input) {
        const file = input.files[0];
        if (file) {
            Object.values(connections).forEach(c => c.send({ type: 'file', content: file, fileType: file.type }));
            addFile({ content: file, fileType: file.type }, 'me', myName);
        }
    }

    function addMsg(content, sender, name) {
        const row = document.createElement('div');
        row.className = `msg-row row-${sender}`;
        row.innerHTML = `<div class="msg msg-${sender}"><span class="u-name">${name}</span>${content}</div>`;
        document.getElementById('chat-box').appendChild(row);
        document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
    }

    function addFile(data, sender, name) {
        const row = document.createElement('div');
        row.className = `msg-row row-${sender}`;
        const url = URL.createObjectURL(new Blob([data.content]));
        row.innerHTML = `<div class="msg msg-${sender}"><span class="u-name">${name}</span><img src="${url}" onclick="window.open(this.src)"></div>`;
        document.getElementById('chat-box').appendChild(row);
        document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
    }
</script>
</body>
</html>
