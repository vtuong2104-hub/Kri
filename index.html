<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Squirrel's Paw - Final Fixed</title>
<style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
        font-family: sans-serif;
        background: #f8f9fa;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
    }
    .app-container {
        width: 100%;
        max-width: 400px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    h2 { text-align: center; color: #333; margin-bottom: 10px; }

    textarea, select, .btn {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
        outline: none;
    }
    textarea { height: 80px; resize: none; }

    /* N√∫t ch·ªçn file */
    #fBtn { background: #6c5ce7; color: white; display: none; font-weight: bold; border: none; }

    /* KHUNG BAO QUANH QR - Theo √Ω b·∫°n */
    .qr-frame {
        border: 2px dashed #bbb;
        border-radius: 12px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: #fff;
        margin-top: 10px;
    }
    #qrImg {
        width: 180px; height: 180px;
        margin-bottom: 15px;
        object-fit: contain;
    }

    /* N√∫t b·∫•m x·∫øp d·ªçc d∆∞·ªõi QR */
    .btn { cursor: pointer; border: none; font-weight: bold; color: white; margin-top: 8px; }
    .btn-qr { background: #0984e3; }
    .btn-txt { background: #00b894; }

    /* Loading Overlay */
    #loader {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.9);
        display: none; flex-direction: column;
        justify-content: center; align-items: center; z-index: 1000;
    }
    .spin {
        width: 40px; height: 40px;
        border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
        border-radius: 50%; animation: s 0.6s linear infinite;
    }
    @keyframes s { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loader">
    <div class="spin"></div>
    <p style="margin-top:10px;">‚ö° ƒêang tƒÉng t·ªëc x·ª≠ l√Ω 500%...</p>
</div>

<div class="app-container">
    <h2>Squirrel's Paw</h2>

    <input type="file" id="fIn" style="display:none">
    <button id="fBtn" onclick="document.getElementById('fIn').click()">üìÅ CH·ªåN FILE (BASE64)</button>

    <textarea id="txtIn" placeholder="D√°n link ho·∫∑c n·ªôi dung..."></textarea>

    <select id="mode">
        <option value="binary">M√£ Nh·ªã ph√¢n</option>
        <option value="decimal">M√£ Th·∫≠p ph√¢n</option>
        <option value="base64">M√£ Base64 (H·ªó tr·ª£ File)</option>
    </select>

    <div class="qr-frame">
        <img id="qrImg" src="https://via.placeholder.com/180?text=QR+Code">
        
        <button class="btn btn-qr" onclick="dlQR()">T·∫¢I QR PNG</button>
        
        <button class="btn btn-txt" onclick="dlTXT()">T·∫¢I FILE .TXT</button>
    </div>
</div>

<script>
    const txtIn = document.getElementById('txtIn');
    const mode = document.getElementById('mode');
    const qrImg = document.getElementById('qrImg');
    const fBtn = document.getElementById('fBtn');
    const fIn = document.getElementById('fIn');
    const loader = document.getElementById('loader');

    let resultData = ""; // L∆∞u k·∫øt qu·∫£ ng·∫ßm
    let qrPath = "";

    mode.onchange = () => {
        fBtn.style.display = (mode.value === 'base64') ? 'block' : 'none';
        run();
    };

    fIn.onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;

        loader.style.display = "flex";
        const reader = new FileReader();
        reader.onload = (ev) => {
            resultData = ev.target.result;
            txtIn.value = "[File: " + file.name + "]";
            qrImg.src = "https://via.placeholder.com/180?text=FILE+TOO+LARGE";
            qrPath = "";
            loader.style.display = "none";
        };
        // T·ªëi ∆∞u h√≥a ƒë·ªçc file c·ª±c nhanh
        reader.readAsDataURL(file);
    };

    function run() {
        let val = txtIn.value.trim();
        if(val.startsWith('[File:')) return;

        if(!val) {
            resultData = "";
            qrImg.src = "https://via.placeholder.com/180?text=QR+Code";
            return;
        }

        // TƒÉng t·ªëc x·ª≠ l√Ω chu·ªói b·∫±ng v√≤ng l·∫∑p t·ªëi ∆∞u
        if(mode.value === 'base64') {
            try { resultData = btoa(unescape(encodeURIComponent(val))); }
            catch(e) { resultData = "Error"; }
        } else {
            let res = "", len = val.length;
            for(let i=0; i<len; i++) {
                let code = val.charCodeAt(i);
                res += (mode.value === 'binary' ? code.toString(2).padStart(8,'0') : code.toString(10)) + " ";
            }
            resultData = res.trim();
        }

        if(val.length > 1000) {
            qrImg.src = "https://via.placeholder.com/180?text=TOO+LONG";
            qrPath = "";
        } else {
            qrPath = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(val)}`;
            qrImg.src = qrPath;
        }
    }

    txtIn.oninput = run;

    // FIX L·ªñI: T·∫£i tr·ª±c ti·∫øp kh√¥ng m·ªü tab m·ªõi
    async function dlQR() { 
        if(!qrPath) return alert("Kh√¥ng c√≥ QR!");
        try {
            const resp = await fetch(qrPath);
            const blob = await resp.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'QR_Code.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch(e) {
            window.open(qrPath, '_blank');
        }
    }
    
    function dlTXT() {
        if(!resultData) return alert("Tr·ªëng!");
        const blob = new Blob([resultData], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "encoded_data.txt";
        a.click();
    }
</script>
</body>
</html>
