<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Squirrel's Paw - Pro Encoder v4</title>
<style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    .app-container { width: 100%; max-width: 420px; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 15px; }
    
    h2 { text-align: center; color: #333; }
    select, .btn, .url-input, textarea, .modal-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 14px; outline: none; }
    
    #fBtn { background: #6c5ce7; color: white; font-weight: bold; border: none; cursor: pointer; }
    .btn-main { background: #00b894; color: white; border: none; font-weight: bold; cursor: pointer; padding: 15px; }
    .btn-qr { background: #0984e3; color: white; border: none; width: auto; padding: 10px 20px; margin-top: 10px; cursor: pointer; border-radius: 8px; }

    /* Thanh ti·∫øn tr√¨nh */
    .progress-container { width: 100%; background: #eee; border-radius: 10px; height: 10px; display: none; overflow: hidden; }
    #progressBar { width: 0%; height: 100%; background: #6c5ce7; transition: width 0.1s; }
    #progressText { font-size: 11px; text-align: center; color: #6c5ce7; display: none; font-weight: bold; }

    #status { font-size: 12px; text-align: center; font-weight: bold; display: none; padding: 10px; border-radius: 8px; }
    .status-success { color: #00b894; background: #e6faf5; }
    .status-error { color: #d63031; background: #fab1a0; }

    #qrSection { border: 2px dashed #ddd; border-radius: 15px; padding: 20px; display: flex; flex-direction: column; align-items: center; background: #fafafa; }
    #qrImg { width: 180px; height: 180px; background: white; border: 1px solid #eee; object-fit: contain; }

    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; color: white; }
    .modal-box { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; color: #333; }
</style>
</head>
<body>

<div id="loader" class="overlay">
    <div style="width: 45px; height: 45px; border: 5px solid #f3f3f3; border-top: 5px solid #6c5ce7; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;"></div>
    <b id="loaderText">ƒêang x·ª≠ l√Ω...</b>
</div>

<div class="app-container">
    <h2>Squirrel's Paw</h2>

    <select id="mode">
        <option value="binary">M√£ Nh·ªã ph√¢n (VƒÉn b·∫£n/File)</option>
        <option value="decimal">M√£ Th·∫≠p ph√¢n (VƒÉn b·∫£n/File)</option>
        <option value="base64">M√£ Base64 (·∫¢nh/Video)</option>
    </select>

    <button id="fBtn" class="btn" onclick="document.getElementById('fIn').click()">üìÅ CH·ªåN FILE ƒê·ªÇ CHUY·ªÇN ƒê·ªîI</button>
    <input type="file" id="fIn" style="display:none">

    <div class="progress-container" id="pCont"><div id="progressBar"></div></div>
    <p id="progressText">0%</p>

    <div id="status"></div>

    <textarea id="txtIn" rows="4" placeholder="Nh·∫≠p vƒÉn b·∫£n v√†o ƒë√¢y ƒë·ªÉ t·∫°o QR..."></textarea>

    <div id="qrSection">
        <img id="qrImg" src="https://via.placeholder.com/180?text=CH∆ØA+C√ì+D·ªÆ+LI·ªÜU">
        <button id="dlQrBtn" class="btn-qr" onclick="dlQR()">T·∫¢I M√É QR</button>
        <p id="qrError" style="color:red; font-size:11px; margin-top:10px; display:none;">QR kh√¥ng h·ªó tr·ª£ n·ªôi dung file qu√° d√†i!</p>
    </div>

    <button class="btn btn-main" onclick="openDownloadModal()">XU·∫§T FILE VƒÇN B·∫¢N (.TXT)</button>
</div>

<div id="modalName" class="overlay">
    <div class="modal-box">
        <h3>üìÇ T·∫£i v·ªÅ file .txt</h3>
        <input type="text" id="fileNameInput" class="modal-input" placeholder="T√™n file..." style="margin-top:15px;">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn" onclick="closeModal()">H·ª¶Y</button>
            <button class="btn" style="background:#6c5ce7; color:white;" onclick="confirmDownload()">T·∫¢I XU·ªêNG</button>
        </div>
    </div>
</div>

<script>
    const mode = document.getElementById('mode');
    const txtIn = document.getElementById('txtIn');
    const fIn = document.getElementById('fIn');
    const qrImg = document.getElementById('qrImg');
    const status = document.getElementById('status');
    const pCont = document.getElementById('pCont');
    const pBar = document.getElementById('progressBar');
    const pText = document.getElementById('progressText');
    const qrError = document.getElementById('qrError');

    let resultData = "";
    let qrPath = "";

    // 1. X·ª¨ L√ù KHI NH·∫¨P VƒÇN B·∫¢N TR·ª∞C TI·∫æP (T·∫°o QR)
    txtIn.oninput = () => {
        let val = txtIn.value.trim();
        if (!val) {
            resetQR();
            return;
        }
        
        // Chuy·ªÉn ƒë·ªïi theo ch·∫ø ƒë·ªô
        let encoded = "";
        for (let i = 0; i < val.length; i++) {
            let code = val.charCodeAt(i);
            if (mode.value === 'binary') encoded += code.toString(2).padStart(8, '0') + " ";
            else if (mode.value === 'decimal') encoded += code.toString(10) + " ";
            else encoded = btoa(val); // T·∫°m th·ªùi cho Base64 vƒÉn b·∫£n
        }
        
        resultData = (mode.value === 'base64' && !val.includes("data:")) ? btoa(val) : encoded.trim();
        updateQRView(resultData);
    };

    // 2. X·ª¨ L√ù KHI CH·ªåN FILE (Chuy·ªÉn ƒë·ªïi nh·ªã ph√¢n/th·∫≠p ph√¢n/base64)
    fIn.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        pCont.style.display = 'block';
        pText.style.display = 'block';
        showStatus("ƒêang x·ª≠ l√Ω file...", "");

        const reader = new FileReader();
        reader.onload = async function(event) {
            const bytes = new Uint8Array(event.target.result);
            let encoded = "";
            const total = bytes.length;

            if (mode.value === 'base64') {
                resultData = await toBase64(file);
                finishProcess(file.name);
            } else {
                // X·ª≠ l√Ω theo t·ª´ng kh·ªëi ƒë·ªÉ c·∫≠p nh·∫≠t ti·∫øn tr√¨nh (tr√°nh treo tr√¨nh duy·ªát)
                for (let i = 0; i < total; i++) {
                    if (mode.value === 'binary') encoded += bytes[i].toString(2).padStart(8, '0') + " ";
                    else encoded += bytes[i].toString(10) + " ";

                    if (i % 5000 === 0) { // C·∫≠p nh·∫≠t ti·∫øn tr√¨nh m·ªói 5000 bytes
                        let percent = Math.round((i / total) * 100);
                        pBar.style.width = percent + "%";
                        pText.innerText = `ƒêang chuy·ªÉn ƒë·ªïi: ${percent}%`;
                        await new Promise(r => setTimeout(r, 0)); // Ngh·ªâ ƒë·ªÉ UI c·∫≠p nh·∫≠t
                    }
                }
                resultData = encoded.trim();
                finishProcess(file.name);
            }
        };
        reader.readAsArrayBuffer(file);
    };

    function finishProcess(fileName) {
        pBar.style.width = "100%";
        pText.innerText = "Ho√†n t·∫•t 100%!";
        txtIn.value = `[ƒê√É M√É H√ìA FILE]\nT√™n: ${fileName}\nƒê·ªô d√†i m√£: ${resultData.length} k√Ω t·ª±.\nNh·∫•n n√∫t Xu·∫•t File ƒë·ªÉ t·∫£i m√£ v·ªÅ.`;
        updateQRView(resultData, true); // True l√† t·ª´ file
        showStatus("‚úÖ ƒê√£ chuy·ªÉn ƒë·ªïi th√†nh c√¥ng!", "status-success");
    }

    function updateQRView(data, isFromFile = false) {
        if (data.length > 2800 || isFromFile) {
            qrImg.src = "https://via.placeholder.com/180?text=KH√îNG+H·ªñ+TR·ª¢+FILE";
            qrError.style.display = 'block';
            qrPath = "";
        } else {
            qrError.style.display = 'none';
            qrPath = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(data)}`;
            qrImg.src = qrPath;
        }
    }

    function resetQR() {
        qrImg.src = "https://via.placeholder.com/180?text=CH∆ØA+C√ì+D·ªÆ+LI·ªÜU";
        qrPath = "";
        qrError.style.display = 'none';
    }

    // Chuy·ªÉn Base64 nhanh
    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const r = new FileReader();
            r.readAsDataURL(file);
            r.onload = () => resolve(r.result);
            r.onerror = e => reject(e);
        });
    }

    // UI & Download
    function showStatus(msg, cls) { status.innerText = msg; status.className = 'status ' + cls; status.style.display = 'block'; }
    function openDownloadModal() { if(!resultData) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!"); document.getElementById('modalName').style.display = 'flex'; }
    function closeModal() { document.getElementById('modalName').style.display = 'none'; }
    function confirmDownload() {
        let name = document.getElementById('fileNameInput').value || "data";
        const blob = new Blob([resultData], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = name + ".txt";
        a.click();
        closeModal();
    }
    async function dlQR() {
        if(!qrPath) return alert("Kh√¥ng c√≥ m√£ QR ƒë·ªÉ t·∫£i!");
        const r = await fetch(qrPath);
        const b = await r.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b); a.download = "QR_Code.png"; a.click();
    }
</script>
<style> @keyframes spin { to { transform: rotate(360deg); } } </style>
</body>
</html>
