<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Squirrel's Paw - Pro Converter v7</title>
<style>
    :root {
        --primary-color: #6c5ce7;
        --secondary-color: #00b894;
        --accent-color: #e84393;
        --download-color: #ff7675;
        --bg-color: #f0f2f5;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
        font-family: 'Segoe UI', sans-serif; 
        background: var(--bg-color); 
        display: flex; justify-content: center; align-items: center; 
        min-height: 100vh; padding: 20px; 
    }

    .app-container { 
        width: 100%; max-width: 450px; background: white; 
        padding: 30px; border-radius: 24px; 
        box-shadow: 0 20px 40px rgba(0,0,0,0.08); 
        display: flex; flex-direction: column; gap: 15px; 
    }

    h2 { text-align: center; color: #2d3436; font-size: 24px; }
    select, .btn, .url-input, textarea, .modal-input { 
        width: 100%; padding: 14px; border-radius: 12px; 
        border: 1.5px solid #eee; font-size: 15px; outline: none; 
    }

    .url-group { display: flex; gap: 10px; }
    .btn-url { background: var(--accent-color); color: white; border: none; font-weight: bold; cursor: pointer; width: 100px; }
    #fBtn { background: var(--primary-color); color: white; border: none; font-weight: 600; cursor: pointer; }
    .btn-main { background: var(--secondary-color); color: white; border: none; font-weight: bold; cursor: pointer; padding: 16px; font-size: 16px; }
    
    /* N√∫t t·∫£i video TikTok m·ªõi */
    #btnDownloadOrigin { 
        background: var(--download-color); color: white; border: none; 
        font-weight: bold; cursor: pointer; padding: 16px; font-size: 16px;
        display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
        transition: all 0.3s;
    }

    /* Progress Bar */
    .progress-wrapper { display: none; margin: 10px 0; }
    .progress-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: var(--primary-color); }
    .progress-container { width: 100%; background: #e9ecef; border-radius: 20px; height: 18px; overflow: hidden; }
    #progressBar { 
        width: 0%; height: 100%; 
        background: linear-gradient(45deg, var(--primary-color) 25%, #a29bfe 25%, #a29bfe 50%, var(--primary-color) 50%, var(--primary-color) 75%, #a29bfe 75%, #a29bfe);
        background-size: 40px 40px; animation: progress-bar-stripes 1s linear infinite; border-radius: 20px;
    }
    @keyframes progress-bar-stripes { from { background-position: 40px 0; } to { background-position: 0 0; } }

    #status { font-size: 13px; text-align: center; font-weight: 500; display: none; padding: 12px; border-radius: 10px; }
    .status-success { color: #009432; background: #e8f5e9; }
    .status-error { color: #c0392b; background: #fdf2f2; }
    textarea { background: #fafafa; color: #636e72; resize: none; font-family: monospace; font-size: 11px; }

    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; color: white; backdrop-filter: blur(4px); }
    .modal-box { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 380px; text-align: center; color: #2d3436; }
</style>
</head>
<body>

<div id="loader" class="overlay">
    <div style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px;"></div>
    <b id="loaderText">ƒêang x·ª≠ l√Ω...</b>
</div>

<div class="app-container">
    <h2>Squirrel's Paw v7</h2>

    <select id="mode">
        <option value="binary">Chuy·ªÉn sang Nh·ªã ph√¢n (Binary)</option>
        <option value="decimal">Chuy·ªÉn sang Th·∫≠p ph√¢n (Decimal)</option>
        <option value="base64">Chuy·ªÉn sang Base64</option>
    </select>

    <div class="url-group">
        <input type="text" id="urlIn" class="url-input" placeholder="D√°n link TikTok t·∫°i ƒë√¢y...">
        <button class="btn btn-url" onclick="processUrl()">M√É H√ìA</button>
    </div>

    <button id="fBtn" class="btn" onclick="document.getElementById('fIn').click()">üìÅ CH·ªåN FILE T·ª™ THI·∫æT B·ªä</button>
    <input type="file" id="fIn" style="display:none">

    <div class="progress-wrapper" id="pWrapper">
        <div class="progress-label"><span id="pFileName">File...</span><span id="pPercentage">0%</span></div>
        <div class="progress-container"><div id="progressBar"></div></div>
    </div>

    <div id="status"></div>
    <textarea id="txtIn" rows="4" readonly placeholder="Th√¥ng tin m√£ h√≥a..."></textarea>

    <button class="btn btn-main" onclick="openModal()">XU·∫§T FILE VƒÇN B·∫¢N (.TXT)</button>
    
    <button id="btnDownloadOrigin" class="btn" onclick="downloadOriginFile()">üì• T·∫¢I VIDEO/·∫¢NH G·ªêC (TIKTOK)</button>
</div>

<div id="modalName" class="overlay">
    <div class="modal-box">
        <h3>üìÇ ƒê·∫∑t t√™n file .txt</h3>
        <input type="text" id="fileNameInput" class="modal-input" placeholder="T√™n file..." style="margin-top:15px;">
        <div style="display:flex; gap:10px; margin-top:25px;">
            <button class="btn" style="background:#dfe6e9;" onclick="closeModal()">H·ª¶Y</button>
            <button class="btn" style="background:var(--primary-color); color:white;" onclick="confirmDownload()">T·∫¢I XU·ªêNG</button>
        </div>
    </div>
</div>

<script>
    const urlIn = document.getElementById('urlIn');
    const pWrapper = document.getElementById('pWrapper');
    const pBar = document.getElementById('progressBar');
    const pPercent = document.getElementById('pPercentage');
    const pFileName = document.getElementById('pFileName');
    const status = document.getElementById('status');
    const loader = document.getElementById('loader');
    const btnDownloadOrigin = document.getElementById('btnDownloadOrigin');

    let resultData = "";
    let originFileUrl = ""; // L∆∞u link t·∫£i tr·ª±c ti·∫øp

    async function processUrl() {
        const url = urlIn.value.trim();
        if(!url) return alert("H√£y d√°n link!");
        
        btnDownloadOrigin.style.display = 'none'; // ·∫®n n√∫t t·∫£i g·ªëc khi b·∫Øt ƒë·∫ßu m·ªõi
        showLoader("üîç ƒêang tr√≠ch xu·∫•t d·ªØ li·ªáu TikTok...");

        try {
            let finalUrl = url;
            if (url.includes("tiktok.com") || url.includes("douyin.com")) {
                const api = await fetch(`https://www.tikwm.com/api/?url=${encodeURIComponent(url)}`);
                const res = await api.json();
                if (res.data && res.data.play) {
                    finalUrl = res.data.play;
                    originFileUrl = finalUrl; // L∆∞u l·∫°i ƒë·ªÉ t·∫£i
                    btnDownloadOrigin.style.display = 'block'; // Hi·ªán n√∫t t·∫£i g·ªëc
                } else {
                    throw new Error("Kh√¥ng t√¨m th·∫•y video. Link c√≥ th·ªÉ b·ªã l·ªói ho·∫∑c ri√™ng t∆∞.");
                }
            }

            showLoader("üì• ƒêang t·∫£i d·ªØ li·ªáu v·ªÅ...");
            const response = await fetch(finalUrl);
            const blob = await response.blob();
            processBuffer(blob, "TikTok_Video");
        } catch (e) {
            hideLoader();
            showStatus("‚ùå L·ªói: " + e.message, "status-error");
        }
    }

    // H√†m t·∫£i video g·ªëc v·ªÅ m√°y
    async function downloadOriginFile() {
        if (!originFileUrl) return;
        showLoader("üöÄ ƒêang chu·∫©n b·ªã t·∫£i video...");
        try {
            const response = await fetch(originFileUrl);
            const blob = await response.blob();
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "tiktok_origin_" + Date.now() + ".mp4";
            link.click();
            hideLoader();
        } catch (e) {
            hideLoader();
            alert("L·ªói khi t·∫£i file g·ªëc. B·∫°n c√≥ th·ªÉ m·ªü link tr·ª±c ti·∫øp: " + originFileUrl);
        }
    }

    // Ch·ªçn file t·ª´ m√°y
    document.getElementById('fIn').onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            btnDownloadOrigin.style.display = 'none';
            processBuffer(file, file.name);
        }
    };

    async function processBuffer(blob, name) {
        hideLoader();
        pWrapper.style.display = 'block';
        pFileName.innerText = name;
        
        const reader = new FileReader();
        reader.onload = async function(e) {
            const bytes = new Uint8Array(e.target.result);
            let encoded = "";
            const total = bytes.length;
            const modeVal = document.getElementById('mode').value;

            if (modeVal === 'base64') {
                pBar.style.width = "100%";
                pPercent.innerText = "100%";
                let binary = '';
                for (let i = 0; i < total; i++) { binary += String.fromCharCode(bytes[i]); }
                encoded = `data:${blob.type};base64,${btoa(binary)}`;
            } else {
                for (let i = 0; i < total; i++) {
                    if (modeVal === 'binary') encoded += bytes[i].toString(2).padStart(8, '0') + " ";
                    else encoded += bytes[i].toString(10) + " ";

                    if (i % 10000 === 0) {
                        let pct = Math.round((i / total) * 100);
                        pBar.style.width = pct + "%";
                        pPercent.innerText = pct + "%";
                        await new Promise(r => setTimeout(r, 0));
                    }
                }
            }
            
            resultData = encoded.trim();
            pBar.style.width = "100%";
            pPercent.innerText = "100%";
            document.getElementById('txtIn').value = `[HO√ÄN T·∫§T]\nT√™n: ${name}\nDung l∆∞·ª£ng: ${(total/1024).toFixed(2)} KB`;
            showStatus("‚úÖ ƒê√≥ng g√≥i th√†nh c√¥ng!", "status-success");
        };
        reader.readAsArrayBuffer(blob);
    }

    function showLoader(t) { document.getElementById('loaderText').innerText = t; loader.style.display = 'flex'; }
    function hideLoader() { loader.style.display = 'none'; }
    function showStatus(m, c) { status.innerText = m; status.className = c; status.style.display = 'block'; }
    function openModal() { if(!resultData) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu!"); document.getElementById('modalName').style.display = 'flex'; }
    function closeModal() { document.getElementById('modalName').style.display = 'none'; }
    function confirmDownload() {
        let n = document.getElementById('fileNameInput').value || "data";
        const b = new Blob([resultData], {type: 'text/plain'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = n + ".txt"; a.click();
        closeModal();
    }
</script>
<style> @keyframes spin { to { transform: rotate(360deg); } } </style>
</body>
</html>
