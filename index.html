<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Squirrel's Paw - Pro Encoder</title>
<style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f0f2f5;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
    }
    .app-container {
        width: 100%;
        max-width: 400px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; color: #333; }
    
    textarea, select, .btn, .modal-input, .url-input {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ddd;
        font-size: 14px;
        outline: none;
    }

    #base64Extra { display: none; flex-direction: column; gap: 10px; }
    #fBtn { background: #6c5ce7; color: white; font-weight: bold; border: none; cursor: pointer; }
    
    #status {
        font-size: 13px; text-align: center; font-weight: bold;
        display: none; padding: 8px; border-radius: 5px;
    }
    .status-success { color: #00b894; background: #e6faf5; }
    .status-wait { color: #e17055; background: #fff3f0; }
    .status-error { color: #d63031; background: #fab1a0; }

    #qrSection {
        border: 2px dashed #ddd; border-radius: 12px; padding: 20px;
        display: flex; flex-direction: column; align-items: center;
        background: #fafafa; margin-top: 10px;
    }
    #qrImg { width: 180px; height: 180px; margin-bottom: 15px; background: white; }

    .btn { cursor: pointer; border: none; font-weight: bold; color: white; transition: 0.2s; }
    .btn:active { transform: scale(0.98); }
    .btn-qr { background: #0984e3; margin-top: 8px; }
    .btn-txt { background: #00b894; margin-top: 8px; }
    .btn-url { background: #e84393; }

    /* LOADER & MODAL OVERLAY */
    .overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        display: none; justify-content: center; align-items: center; z-index: 1000;
    }
    
    .modal-box {
        background: white; padding: 20px; border-radius: 12px;
        width: 90%; max-width: 320px; text-align: center;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-box h3 { margin-bottom: 15px; font-size: 18px; color: #333; }
    .modal-btns { display: flex; gap: 10px; margin-top: 15px; }

    .spin {
        width: 50px; height: 50px;
        border: 5px solid #f3f3f3; border-top: 5px solid #6c5ce7;
        border-radius: 50%; animation: s 0.8s linear infinite;
    }
    @keyframes s { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="modalName" class="overlay">
    <div class="modal-box">
        <h3>üìÇ ƒê·∫∑t t√™n file</h3>
        <input type="text" id="fileNameInput" class="modal-input" placeholder="V√≠ d·ª•: tailieu_matma">
        <div class="modal-btns">
            <button class="btn" style="background:#b2bec3" onclick="closeModal()">H·ª¶Y</button>
            <button class="btn" style="background:#6c5ce7" onclick="confirmDownload()">T·∫¢I XU·ªêNG</button>
        </div>
    </div>
</div>

<div id="loader" class="overlay" style="background: rgba(255,255,255,0.9); flex-direction: column;">
    <div class="spin"></div>
    <p id="loaderText" style="margin-top:15px; font-weight: bold; color: #6c5ce7;">‚ö° ƒêang x·ª≠ l√Ω...</p>
</div>

<div class="app-container">
    <h2>Squirrel's Paw</h2>

    <select id="mode">
        <option value="binary">M√£ Nh·ªã ph√¢n</option>
        <option value="decimal">M√£ Th·∫≠p ph√¢n</option>
        <option value="base64">M√£ Base64 (H·ªó tr·ª£ File/URL)</option>
    </select>

    <div id="base64Extra">
        <input type="file" id="fIn" style="display:none">
        <button id="fBtn" class="btn" onclick="document.getElementById('fIn').click()">üìÅ CH·ªåN FILE T·ª™ M√ÅY</button>
        <div style="display: flex; gap: 5px;">
            <input type="text" id="urlIn" class="url-input" placeholder="D√°n link ·∫£nh/video v√†o ƒë√¢y...">
            <button class="btn btn-url" onclick="processUrl()" style="width: 80px;">T·∫¢I</button>
        </div>
    </div>
    
    <div id="status"></div>

    <textarea id="txtIn" placeholder="D√°n n·ªôi dung vƒÉn b·∫£n t·∫°i ƒë√¢y..."></textarea>

    <div id="qrSection">
        <img id="qrImg" src="https://via.placeholder.com/180?text=QR+READY">
        <button class="btn btn-qr" onclick="dlQR()">T·∫¢I QR PNG</button>
    </div>

    <button class="btn btn-txt" onclick="openModal()">T·∫¢I K·∫æT QU·∫¢ .TXT</button>
</div>

<script>
    const txtIn = document.getElementById('txtIn');
    const mode = document.getElementById('mode');
    const qrSection = document.getElementById('qrSection');
    const base64Extra = document.getElementById('base64Extra');
    const fIn = document.getElementById('fIn');
    const urlIn = document.getElementById('urlIn');
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loaderText');
    const status = document.getElementById('status');
    const qrImg = document.getElementById('qrImg');
    const modalName = document.getElementById('modalName');
    const fileNameInput = document.getElementById('fileNameInput');

    let resultData = ""; 
    let qrPath = "";

    mode.onchange = () => {
        const isBase64 = (mode.value === 'base64');
        base64Extra.style.display = isBase64 ? 'flex' : 'none';
        qrSection.style.display = isBase64 ? 'none' : 'flex';
        status.style.display = 'none';
        run();
    };

    // X·ª≠ l√Ω File t·ª´ m√°y
    fIn.onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        handleFileConversion(file);
    };

    // X·ª≠ l√Ω Link URL (·∫¢nh/Video)
    async function processUrl() {
        const url = urlIn.value.trim();
        if(!url) return alert("Vui l√≤ng d√°n link!");

        showLoading("üåê ƒêang t·∫£i d·ªØ li·ªáu t·ª´ li√™n k·∫øt...");
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("Kh√¥ng th·ªÉ truy c·∫≠p link n√†y (L·ªói CORS ho·∫∑c link h·ªèng)");
            
            const blob = await response.blob();
            // T·∫°o m·ªôt file ·∫£o t·ª´ blob ƒë·ªÉ d√πng l·∫°i h√†m handle
            const fileName = url.split('/').pop().split('#')[0].split('?')[0] || "file_tu_link";
            const file = new File([blob], fileName, { type: blob.type });
            
            handleFileConversion(file);
        } catch (error) {
            loader.style.display = "none";
            showStatus("‚ùå L·ªói: Kh√¥ng th·ªÉ t·∫£i file. Link c√≥ th·ªÉ ch·∫∑n truy c·∫≠p tr·ª±c ti·∫øp.", "status-error");
            console.error(error);
        }
    }

    function handleFileConversion(file) {
        showLoading("‚ö° ƒêang m√£ h√≥a d·ªØ li·ªáu 500%...");
        
        const reader = new FileReader();
        reader.onload = (ev) => {
            setTimeout(() => {
                resultData = ev.target.result;
                txtIn.value = "[D·ªØ li·ªáu m√£ h√≥a: " + file.name + " (" + file.type + ")]";
                showStatus("‚úÖ ƒê√£ t·∫°o Base64 th√†nh c√¥ng!", "status-success");
                loader.style.display = "none";
            }, 1000);
        };
        reader.onerror = () => {
            loader.style.display = "none";
            showStatus("‚ùå L·ªói khi ƒë·ªçc file!", "status-error");
        };
        reader.readAsDataURL(file);
    }

    function showLoading(text) {
        loaderText.innerText = text;
        loader.style.display = "flex";
    }

    function showStatus(msg, className) {
        status.className = className;
        status.innerText = msg;
        status.style.display = "block";
    }

    function run() {
        let val = txtIn.value.trim();
        if(val.startsWith('[D·ªØ li·ªáu')) return;
        if(!val) { resultData = ""; qrImg.src = "https://via.placeholder.com/180?text=QR+READY"; return; }

        if(mode.value === 'base64') {
            try { resultData = btoa(unescape(encodeURIComponent(val))); } catch(e) { resultData = "Error"; }
        } else {
            let res = "";
            for(let i=0; i<val.length; i++) {
                let code = val.charCodeAt(i);
                res += (mode.value === 'binary' ? code.toString(2).padStart(8,'0') : code.toString(10)) + " ";
            }
            resultData = res.trim();
            qrPath = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(val)}`;
            qrImg.src = qrPath;
        }
    }
    txtIn.oninput = run;

    function openModal() {
        if(!resultData) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu!");
        modalName.style.display = "flex";
        fileNameInput.focus();
    }

    function closeModal() {
        modalName.style.display = "none";
        fileNameInput.value = "";
    }

    function confirmDownload() {
        let name = fileNameInput.value.trim() || "squirrel_data";
        closeModal();
        showLoading("üíæ ƒêang chu·∫©n b·ªã file...");
        
        setTimeout(() => {
            const blob = new Blob([resultData], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name + ".txt";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            loader.style.display = "none";
        }, 800);
    }

    async function dlQR() { 
        if(!qrPath) return alert("Kh√¥ng c√≥ QR!");
        const resp = await fetch(qrPath);
        const blob = await resp.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'QR_Code.png';
        a.click();
    }
</script>
</body>
</html>
