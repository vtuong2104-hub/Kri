<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ketnoi090 - Group Cloud</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #000; --primary: #00d2ff; --me: #0084ff; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Video Grid: T·ª± ƒë·ªông chia √¥ (2x2 n·∫øu c√≥ 4 ng∆∞·ªùi) */
        #video-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(45%, 1fr)); 
            gap: 5px; 
            padding: 5px; 
            background: #080808;
            max-height: 40vh; /* Gi·ªõi h·∫°n chi·ªÅu cao video ƒë·ªÉ nh∆∞·ªùng ch·ªó cho chat */
            overflow-y: auto;
        }
        .v-box { position: relative; background: #222; border-radius: 8px; overflow: hidden; height: 120px; border: 1px solid #333; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .tag { position: absolute; bottom: 5px; left: 5px; font-size: 10px; background: rgba(0,0,0,0.6); padding: 2px 5px; border-radius: 3px; }

        /* Khung Chat: Lu√¥n hi·ªÉn th·ªã ·ªü gi·ªØa */
        #chat-box { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            padding-bottom: 80px; /* Ch·ª´a ch·ªó cho thanh nh·∫≠p li·ªáu fixed */
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            background: #000; 
        }
        .msg-row { display: flex; width: 100%; }
        .row-me { justify-content: flex-end; }
        .row-remote { justify-content: flex-start; }
        .msg { padding: 8px 12px; border-radius: 15px; max-width: 75%; font-size: 14px; }
        .msg-me { background: var(--me); border-bottom-right-radius: 2px; }
        .msg-remote { background: #333; border-bottom-left-radius: 2px; }

        /* Thanh nh·∫≠p li·ªáu: C·ªê ƒê·ªäNH ·ªû ƒê√ÅY */
        #input-bar { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            padding: 10px; 
            display: flex; 
            gap: 8px; 
            background: #1a1a1a; 
            border-top: 1px solid #333; 
            z-index: 1000;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }
        #msg-in { flex: 1; padding: 10px 15px; border-radius: 20px; border: none; background: #333; color: white; outline: none; }

        #overlay { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="overlay">
    <div style="background:#1a1a1a; padding:25px; border-radius:20px; text-align:center; width:280px;">
        <h2 style="color:var(--primary)">KETNOI090</h2>
        <input type="text" id="user-name" placeholder="T√™n b·∫°n..." style="width:100%; padding:10px; margin:10px 0; background:#000; color:white; border:1px solid #444; border-radius:8px; text-align:center;">
        <button onclick="startApp()" style="width:100%; padding:12px; background:var(--primary); border:none; border-radius:8px; font-weight:bold;">V√ÄO PH√íNG</button>
    </div>
</div>

<div id="video-grid">
    <div class="v-box">
        <video id="local-video" autoplay muted playsinline style="transform: scaleX(-1);"></video>
        <div class="tag">T√¥i</div>
    </div>
</div>

<div id="chat-box"></div>

<div id="input-bar">
    <button style="background:none; border:none; font-size:20px;" onclick="document.getElementById('file-in').click()">üì∑</button>
    <input type="file" id="file-in" hidden accept="image/*" onchange="sendFile(this)">
    <input type="text" id="msg-in" placeholder="Nh·∫Øn tin..." onkeypress="if(event.key==='Enter') sendText()">
    <button onclick="sendText()" style="background:var(--primary); border:none; border-radius:50%; width:40px; height:40px;">üöÄ</button>
</div>

<script>
    const BIN_ID = "694d410443b1c97be9047914"; 
    const API_KEY = "$2a$10$2BLENCGAiBNnNJFMRICHTedOtWa19TvenTNDCWmE7oQD6iugGK0be";

    let peer, localStream, myName;
    let connections = {};

    async function startApp() {
        myName = document.getElementById('user-name').value.trim();
        if(!myName) return alert("Nh·∫≠p t√™n!");
        
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true }).catch(() => null);
        document.getElementById('local-video').srcObject = localStream;
        document.getElementById('overlay').style.display = 'none';

        peer = new Peer();
        peer.on('open', async (myId) => {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { "X-Master-Key": API_KEY } });
            const data = await res.json();
            const hostId = data.record.hostId;

            if (!hostId || hostId === "") {
                await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT', headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
                    body: JSON.stringify({ hostId: myId })
                });
            } else {
                // T·ª± ƒë·ªông k·∫øt n·ªëi v·ªõi host
                setupData(peer.connect(hostId));
                peer.call(hostId, localStream);
            }
        });

        peer.on('call', (call) => {
            call.answer(localStream);
            setupVideo(call);
        });
        peer.on('connection', setupData);
    }

    function setupData(conn) {
        connections[conn.peer] = conn;
        conn.on('data', (data) => {
            if(data.type === 'text') addMsg(data.content, 'remote', data.name);
            if(data.type === 'image') addImg(data.content, 'remote', data.name);
        });
    }

    function setupVideo(call) {
        call.on('stream', (stream) => {
            if (document.getElementById('v-' + call.peer)) return;
            const box = document.createElement('div');
            box.className = 'v-box'; box.id = 'v-' + call.peer;
            const v = document.createElement('video');
            v.srcObject = stream; v.autoplay = true; v.playsInline = true;
            box.appendChild(v);
            document.getElementById('video-grid').appendChild(box);
        });
    }

    function sendText() {
        const input = document.getElementById('msg-in');
        if(input.value.trim()) {
            Object.values(connections).forEach(c => c.send({ type: 'text', content: input.value, name: myName }));
            addMsg(input.value, 'me', myName);
            input.value = '';
        }
    }

    function addMsg(txt, side, name) {
        const div = document.createElement('div');
        div.className = `msg-row row-${side}`;
        div.innerHTML = `<div class="msg msg-${side}"><small style="display:block;font-size:10px;opacity:0.5">${name}</small>${txt}</div>`;
        document.getElementById('chat-box').appendChild(div);
        document.getElementById('chat-box').scrollTop = 9999;
    }
    // (Ph·∫ßn g·ª≠i ·∫£nh gi·ªØ nguy√™n nh∆∞ b·∫£n tr∆∞·ªõc...)
</script>
</body>
</html>
