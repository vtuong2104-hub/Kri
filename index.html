<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ketnoi090 - Camera & Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #000; --primary: #00d2ff; --me: #0084ff; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; width: 100vw; overflow: hidden; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #111; border-bottom: 1px solid #333; height: 50px; flex-shrink: 0; }

        /* Video Area - Lu√¥n hi·ªÉn th·ªã ·ªü tr√™n c√πng */
        #video-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; padding: 4px; background: #080808; flex-shrink: 0; }
        .v-box { position: relative; background: #222; border-radius: 10px; overflow: hidden; height: 140px; border: 1px solid #333; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .tag { position: absolute; bottom: 5px; left: 5px; font-size: 10px; background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 4px; }

        /* KHUNG CHAT - Chi·∫øm kh√¥ng gian ch√≠nh ·ªü gi·ªØa */
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #0a0a0a; border-top: 1px solid #222; }
        .msg-row { display: flex; width: 100%; }
        .row-me { justify-content: flex-end; }
        .row-remote { justify-content: flex-start; }
        .msg { padding: 10px 14px; border-radius: 18px; max-width: 75%; font-size: 14px; line-height: 1.4; word-break: break-word; }
        .msg-me { background: var(--me); border-bottom-right-radius: 2px; }
        .msg-remote { background: #333; border-bottom-left-radius: 2px; }
        .u-name { font-size: 10px; opacity: 0.5; margin-bottom: 2px; display: block; }

        /* Input Bar - Lu√¥n ·ªü d∆∞·ªõi c√πng */
        #input-bar { padding: 10px; display: flex; gap: 8px; background: #1a1a1a; border-top: 1px solid #333; align-items: center; padding-bottom: calc(10px + env(safe-area-inset-bottom)); flex-shrink: 0; }
        #msg-in { flex: 1; padding: 10px 15px; border-radius: 20px; border: none; background: #333; color: white; outline: none; font-size: 16px; }

        /* M√†n h√¨nh ch·ªù nh·∫≠p t√™n */
        #overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .card { background: #1a1a1a; padding: 25px; border-radius: 20px; text-align: center; border: 1px solid #333; width: 100%; max-width: 300px; }
        .card input { width: 100%; padding: 12px; margin: 15px 0; border-radius: 8px; border: 1px solid #444; background: #000; color: white; text-align: center; }
    </style>
</head>
<body>

<div id="overlay">
    <div class="card">
        <h2 style="color:var(--primary); margin:0;">KETNOI090</h2>
        <p style="font-size:12px; color:#888;">Nh√¨n th·∫•y nhau & Chat tr·ª±c ti·∫øp</p>
        <input type="text" id="user-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
        <button onclick="startApp()" style="width:100%; padding:12px; border-radius:8px; border:none; background:var(--primary); font-weight:bold; cursor:pointer;">B·∫ÆT ƒê·∫¶U</button>
    </div>
</div>

<header>
    <span style="color:var(--primary); font-weight:bold;">KETNOI090 Cloud</span>
    <button onclick="resetRoom()" style="background:none; border:none; color:#ff4444; font-size:14px; cursor:pointer;">üîÑ Reset Ph√≤ng</button>
</header>

<div id="video-grid">
    <div class="v-box">
        <video id="local-video" autoplay muted playsinline style="transform: scaleX(-1);"></video>
        <div class="tag">T√¥i</div>
    </div>
    </div>

<div id="chat-box">
    <div style="text-align:center; font-size:11px; color:#555; margin:10px 0;">H·ªá th·ªëng: ƒêang ch·ªù k·∫øt n·ªëi...</div>
</div>

<div id="input-bar">
    <input type="file" id="file-in" hidden accept="image/*" onchange="sendFile(this)">
    <button style="background:none; border:none; font-size:20px;" onclick="document.getElementById('file-in').click()">üì∑</button>
    <input type="text" id="msg-in" placeholder="Nh·∫Øn tin..." onkeypress="if(event.key==='Enter') sendText()">
    <button onclick="sendText()" style="background:var(--primary); border:none; border-radius:50%; width:40px; height:40px; color:black; font-weight:bold;">üöÄ</button>
</div>

<script>
    // S·ª¨ D·ª§NG BIN ID V√Ä KEY C·ª¶A B·∫†N
    const BIN_ID = "694d410443b1c97be9047914"; 
    const API_KEY = "$2a$10$2BLENCGAiBNnNJFMRICHTedOtWa19TvenTNDCWmE7oQD6iugGK0be";

    let peer, localStream, myName;
    let connections = {};

    async function startApp() {
        myName = document.getElementById('user-name').value.trim();
        if(!myName) return alert("Vui l√≤ng nh·∫≠p t√™n!");
        
        // M·ªü camera ngay l·∫≠p t·ª©c
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('local-video').srcObject = localStream;
        } catch (e) {
            alert("L·ªói: Kh√¥ng m·ªü ƒë∆∞·ª£c Camera. H√£y ki·ªÉm tra quy·ªÅn truy c·∫≠p.");
            return;
        }

        document.getElementById('overlay').style.display = 'none';

        peer = new Peer();
        peer.on('open', async (myId) => {
            try {
                // Ki·ªÉm tra ID tr√™n Cloud
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                    headers: { "X-Master-Key": API_KEY }
                });
                const data = await res.json();
                const currentHost = data.record.hostId;

                if (!currentHost || currentHost === "") {
                    // M√¨nh v√†o tr∆∞·ªõc -> Ghi t√™n l√™n Cloud
                    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                        method: 'PUT',
                        headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
                        body: JSON.stringify({ hostId: myId })
                    });
                    addMsg("B·∫°n ƒë√£ v√†o ph√≤ng. H√£y b·∫£o b·∫°n b√® truy c·∫≠p ƒë·ªÉ nh√¨n th·∫•y nhau.", "remote", "H·ªá th·ªëng");
                } else if (currentHost !== myId) {
                    // C√≥ ng∆∞·ªùi r·ªìi -> T·ª± ƒë·ªông k·∫øt n·ªëi camera v√† chat
                    const conn = peer.connect(currentHost);
                    setupData(conn);
                    const call = peer.call(currentHost, localStream);
                    setupVideo(call);
                }
            } catch (e) { addMsg("L·ªói Cloud! H√£y nh·∫•n Reset.", "remote", "L·ªói"); }
        });

        peer.on('call', (call) => {
            call.answer(localStream);
            setupVideo(call);
        });
        peer.on('connection', setupData);
    }

    function setupData(conn) {
        conn.on('open', () => {
            connections[conn.peer] = conn;
            addMsg("ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng!", "remote", "H·ªá th·ªëng");
            conn.on('data', (data) => {
                if(data.type === 'text') addMsg(data.content, 'remote', data.name);
                if(data.type === 'image') addImg(data.content, 'remote', data.name);
            });
        });
    }

    function setupVideo(call) {
        call.on('stream', (stream) => {
            if (document.getElementById('v-' + call.peer)) return;
            const box = document.createElement('div');
            box.className = 'v-box'; box.id = 'v-' + call.peer;
            const v = document.createElement('video');
            v.srcObject = stream; v.autoplay = true; v.playsInline = true;
            const t = document.createElement('div'); t.className = 'tag'; t.innerText = "B·∫°n b√®";
            box.appendChild(v); box.appendChild(t);
            document.getElementById('video-grid').appendChild(box);
        });
    }

    async function resetRoom() {
        if(!confirm("L√†m m·ªõi ph√≤ng?")) return;
        await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
            method: 'PUT',
            headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
            body: JSON.stringify({ hostId: "" })
        });
        location.reload();
    }

    function sendText() {
        const input = document.getElementById('msg-in');
        if(input.value.trim()) {
            Object.values(connections).forEach(c => c.send({ type: 'text', content: input.value, name: myName }));
            addMsg(input.value, 'me', myName);
            input.value = '';
        }
    }

    function sendFile(input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = () => {
                Object.values(connections).forEach(c => c.send({ type: 'image', content: reader.result, name: myName }));
                addImg(reader.result, 'me', myName);
            };
            reader.readAsDataURL(file);
        }
    }

    function addMsg(txt, side, name) {
        const div = document.createElement('div');
        div.className = `msg-row row-${side}`;
        div.innerHTML = `<div class="msg msg-${side}"><small class="u-name">${name}</small>${txt}</div>`;
        const box = document.getElementById('chat-box');
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function addImg(src, side, name) {
        const div = document.createElement('div');
        div.className = `msg-row row-${side}`;
        div.innerHTML = `<div class="msg msg-${side}"><small class="u-name">${name}</small><img src="${src}" style="max-width:100%; border-radius:10px; margin-top:5px;"></div>`;
        const box = document.getElementById('chat-box');
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }
</script>
</body>
</html>
