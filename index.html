<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Squirrel's Paw - Pro Encoder v2</title>
<style>
    /* T·ªïng quan */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        background: #f0f2f5; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        padding: 20px; 
    }

    .app-container { 
        width: 100%; 
        max-width: 420px; 
        background: white; 
        padding: 25px; 
        border-radius: 20px; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        display: flex;
        flex-direction: column;
        gap: 15px; /* Kho·∫£ng c√°ch chung gi·ªØa c√°c th√†nh ph·∫ßn */
    }

    h2 { text-align: center; color: #333; margin-bottom: 5px; }
    
    /* Input & Select */
    select, .btn, .url-input, textarea, .modal-input { 
        width: 100%; 
        padding: 12px; 
        border-radius: 10px; 
        border: 1px solid #ddd; 
        font-size: 14px; 
        outline: none; 
    }

    /* X·ª≠ l√Ω kho·∫£ng c√°ch n√∫t b·∫•m */
    #base64Extra { 
        display: none; 
        flex-direction: column; 
        gap: 12px; /* Kho·∫£ng c√°ch gi·ªØa n√∫t ch·ªçn file v√† h√†ng nh·∫≠p link */
    }

    .url-group { 
        display: flex; 
        gap: 8px; /* Kho·∫£ng c√°ch gi·ªØa √¥ input v√† n√∫t T·∫£i */
    }

    #fBtn { background: #6c5ce7; color: white; font-weight: bold; border: none; cursor: pointer; }
    .btn-url { background: #e84393; width: 100px; border: none; color: white; font-weight: bold; cursor: pointer; flex-shrink: 0; }
    .btn-main { background: #00b894; color: white; border: none; font-weight: bold; cursor: pointer; padding: 15px; margin-top: 5px; }

    /* Tr·∫°ng th√°i */
    #status { 
        font-size: 13px; text-align: center; font-weight: bold; 
        display: none; padding: 10px; border-radius: 8px; 
    }
    .status-success { color: #00b894; background: #e6faf5; }
    .status-error { color: #d63031; background: #fab1a0; }

    /* QR Section */
    #qrSection { 
        border: 2px dashed #ddd; border-radius: 15px; padding: 20px; 
        display: flex; flex-direction: column; align-items: center; 
        background: #fafafa; gap: 10px;
    }
    #qrImg { width: 180px; height: 180px; background: white; border: 1px solid #eee; }

    /* Overlay & Modal */
    .overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.6); display: none; justify-content: center; 
        align-items: center; z-index: 1000; flex-direction: column; color: white; 
    }
    .modal-box { 
        background: white; padding: 25px; border-radius: 15px; 
        width: 90%; max-width: 350px; text-align: center; color: #333; 
    }
    .modal-btns { display: flex; gap: 10px; margin-top: 20px; }

    /* Hi·ªáu ·ª©ng loading */
    .spin { 
        width: 45px; height: 45px; border: 5px solid #f3f3f3; 
        border-top: 5px solid #6c5ce7; border-radius: 50%; 
        animation: spin 1s linear infinite; margin-bottom: 15px; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .btn:active { transform: scale(0.97); }
    .btn:hover { opacity: 0.9; }
</style>
</head>
<body>

<div id="loader" class="overlay">
    <div class="spin"></div>
    <b id="loaderText">ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</b>
</div>

<div id="modalName" class="overlay">
    <div class="modal-box">
        <h3>üìÇ ƒê·∫∑t t√™n file l∆∞u tr·ªØ</h3>
        <p style="font-size: 12px; color: #888; margin: 8px 0 15px;">D·ªØ li·ªáu video s·∫Ω ƒë∆∞·ª£c l∆∞u d∆∞·ªõi d·∫°ng vƒÉn b·∫£n .txt</p>
        <input type="text" id="fileNameInput" class="modal-input" placeholder="V√≠ d·ª•: video_secret_01">
        <div class="modal-btns">
            <button class="btn" style="background:#b2bec3; color:white; border:none;" onclick="closeModal()">H·ª¶Y</button>
            <button class="btn" style="background:#6c5ce7; color:white; border:none;" onclick="confirmDownload()">T·∫¢I XU·ªêNG</button>
        </div>
    </div>
</div>

<div class="app-container">
    <h2>Squirrel's Paw</h2>

    <select id="mode">
        <option value="binary">M√£ Nh·ªã ph√¢n (VƒÉn b·∫£n)</option>
        <option value="decimal">M√£ Th·∫≠p ph√¢n (VƒÉn b·∫£n)</option>
        <option value="base64">M√£ Base64 (Video / ·∫¢nh / TikTok)</option>
    </select>

    <div id="base64Extra">
        <button id="fBtn" class="btn" onclick="document.getElementById('fIn').click()">üìÅ CH·ªåN FILE T·ª™ M√ÅY</button>
        <input type="file" id="fIn" style="display:none">
        
        <div class="url-group">
            <input type="text" id="urlIn" class="url-input" placeholder="D√°n link TikTok ho·∫∑c Video...">
            <button class="btn btn-url" onclick="processUrl()">M√É H√ìA</button>
        </div>
    </div>

    <div id="status"></div>

    <textarea id="txtIn" rows="4" placeholder="Nh·∫≠p n·ªôi dung vƒÉn b·∫£n ho·∫∑c ch·ªù k·∫øt qu·∫£ m√£ h√≥a file..."></textarea>

    <div id="qrSection">
        <img id="qrImg" src="https://via.placeholder.com/180?text=VƒÇN+B·∫¢N+TR·ªêNG">
        <button class="btn" style="background:#0984e3; color:white; border:none; width:auto; padding: 10px 20px;" onclick="dlQR()">T·∫¢I M√É QR</button>
    </div>

    <button class="btn btn-main" onclick="openModal()">XU·∫§T FILE TXT (BASE64)</button>
</div>

<script>
    const mode = document.getElementById('mode');
    const base64Extra = document.getElementById('base64Extra');
    const qrSection = document.getElementById('qrSection');
    const txtIn = document.getElementById('txtIn');
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loaderText');
    const status = document.getElementById('status');
    const urlIn = document.getElementById('urlIn');
    const fIn = document.getElementById('fIn');
    
    let resultData = ""; 
    let qrPath = "";

    // ƒê·ªïi ch·∫ø ƒë·ªô x·ª≠ l√Ω
    mode.onchange = () => {
        const isB64 = mode.value === 'base64';
        base64Extra.style.display = isB64 ? 'flex' : 'none';
        qrSection.style.display = isB64 ? 'none' : 'flex';
        status.style.display = 'none';
        txtIn.value = "";
        resultData = "";
    };

    // T·∫£i v√† m√£ h√≥a t·ª´ URL (TikTok/Video)
    async function processUrl() {
        const url = urlIn.value.trim();
        if(!url) return alert("Vui l√≤ng d√°n link!");

        showLoading("üîç ƒêang tr√≠ch xu·∫•t video...");
        try {
            let finalUrl = url;

            // X·ª≠ l√Ω TikTok/Douyin qua API trung gian
            if (url.includes("tiktok.com") || url.includes("douyin.com")) {
                const api = await fetch(`https://www.tikwm.com/api/?url=${encodeURIComponent(url)}`);
                const res = await api.json();
                if (res.data && res.data.play) {
                    finalUrl = res.data.play;
                } else {
                    throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c video TikTok. Link c√≥ th·ªÉ b·ªã ri√™ng t∆∞.");
                }
            }

            showLoading("üì• ƒêang t·∫£i d·ªØ li·ªáu g·ªëc (Vui l√≤ng ch·ªù)...");
            const response = await fetch(finalUrl);
            if (!response.ok) throw new Error("Server ch·∫∑n t·∫£i tr·ª±c ti·∫øp. H√£y th·ª≠ link kh√°c.");
            
            const blob = await response.blob();
            encodeBlob(blob, "Video_Link");

        } catch (e) {
            hideLoading();
            showStatus("‚ùå L·ªói: " + e.message, "status-error");
        }
    }

    // Ch·ªçn file t·ª´ m√°y
    fIn.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            showLoading("‚ö° ƒêang ƒë√≥ng g√≥i file...");
            encodeBlob(file, file.name);
        }
    };

    // H√†m m√£ h√≥a chung
    function encodeBlob(blob, name) {
        const reader = new FileReader();
        reader.onloadend = () => {
            resultData = reader.result;
            txtIn.value = `[HO√ÄN T·∫§T ƒê√ìNG G√ìI]\n- T√™n: ${name}\n- ƒê·ªãnh d·∫°ng: ${blob.type}\n- Dung l∆∞·ª£ng: ${(blob.size/1024/1024).toFixed(2)} MB\n\nB·∫°n c√≥ th·ªÉ nh·∫•n T·∫£i xu·ªëng file .txt ph√≠a d∆∞·ªõi.`;
            showStatus("‚úÖ ƒê√£ m√£ h√≥a xong to√†n b·ªô d·ªØ li·ªáu!", "status-success");
            hideLoading();
        };
        reader.readAsDataURL(blob);
    }

    // X·ª≠ l√Ω vƒÉn b·∫£n th∆∞·ªùng
    txtIn.oninput = () => {
        if (mode.value === 'base64') return;
        let val = txtIn.value.trim();
        if (!val) {
            document.getElementById('qrImg').src = "https://via.placeholder.com/180?text=VƒÇN+B·∫¢N+TR·ªêNG";
            return;
        }

        let res = "";
        for (let i = 0; i < val.length; i++) {
            let code = val.charCodeAt(i);
            res += (mode.value === 'binary' ? code.toString(2).padStart(8,'0') : code.toString(10)) + " ";
        }
        resultData = res.trim();
        qrPath = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(val)}`;
        document.getElementById('qrImg').src = qrPath;
    };

    // C√°c h√†m UI
    function showLoading(text) { loaderText.innerText = text; loader.style.display = 'flex'; }
    function hideLoading() { loader.style.display = 'none'; }
    function showStatus(msg, cls) { status.innerText = msg; status.className = cls; status.style.display = 'block'; }
    function openModal() { if(!resultData) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i!"); document.getElementById('modalName').style.display = 'flex'; }
    function closeModal() { document.getElementById('modalName').style.display = 'none'; }
    
    function confirmDownload() {
        let name = document.getElementById('fileNameInput').value.trim() || "squirrel_data";
        const blob = new Blob([resultData], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = name + ".txt";
        a.click();
        closeModal();
    }

    async function dlQR() {
        if(!qrPath) return alert("Vui l√≤ng nh·∫≠p vƒÉn b·∫£n ƒë·ªÉ t·∫°o QR!");
        const r = await fetch(qrPath);
        const b = await r.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = "QR_Code.png";
        a.click();
    }
</script>
</body>
</html>
