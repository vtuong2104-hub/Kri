<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Squirrel's Paw - Ultimate Encoder v5</title>
<style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    .app-container { width: 100%; max-width: 420px; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 15px; }
    
    h2 { text-align: center; color: #333; margin-bottom: 5px; }
    select, .btn, .url-input, textarea, .modal-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 14px; outline: none; }
    
    .url-group { display: flex; gap: 8px; }
    .btn-url { background: #e84393; width: 90px; color: white; font-weight: bold; border: none; cursor: pointer; border-radius: 10px; }
    #fBtn { background: #6c5ce7; color: white; font-weight: bold; border: none; cursor: pointer; }
    .btn-main { background: #00b894; color: white; border: none; font-weight: bold; cursor: pointer; padding: 15px; }
    .btn-qr { background: #0984e3; color: white; border: none; width: auto; padding: 10px 20px; margin-top: 10px; cursor: pointer; border-radius: 8px; }

    .progress-container { width: 100%; background: #eee; border-radius: 10px; height: 10px; display: none; overflow: hidden; margin-top: 5px; }
    #progressBar { width: 0%; height: 100%; background: #6c5ce7; transition: width 0.1s; }
    #progressText { font-size: 11px; text-align: center; color: #6c5ce7; display: none; font-weight: bold; }

    #status { font-size: 12px; text-align: center; font-weight: bold; display: none; padding: 10px; border-radius: 8px; }
    .status-success { color: #00b894; background: #e6faf5; }
    .status-error { color: #d63031; background: #fab1a0; }

    #qrSection { border: 2px dashed #ddd; border-radius: 15px; padding: 20px; display: flex; flex-direction: column; align-items: center; background: #fafafa; }
    #qrImg { width: 160px; height: 160px; background: white; border: 1px solid #eee; object-fit: contain; }

    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; color: white; }
    .modal-box { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; color: #333; }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loader" class="overlay">
    <div style="width: 45px; height: 45px; border: 5px solid #f3f3f3; border-top: 5px solid #6c5ce7; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;"></div>
    <b id="loaderText">ƒêang t·∫£i d·ªØ li·ªáu...</b>
</div>

<div class="app-container">
    <h2>Squirrel's Paw v5</h2>

    <select id="mode">
        <option value="binary">M√£ Nh·ªã ph√¢n (Binary)</option>
        <option value="decimal">M√£ Th·∫≠p ph√¢n (Decimal)</option>
        <option value="base64">M√£ Base64</option>
    </select>

    <div class="url-group">
        <input type="text" id="urlIn" class="url-input" placeholder="D√°n link TikTok ho·∫∑c Video/MP3...">
        <button class="btn-url" onclick="processUrl()">M√É H√ìA</button>
    </div>

    <button id="fBtn" class="btn" onclick="document.getElementById('fIn').click()">üìÅ CH·ªåN FILE T·ª™ M√ÅY</button>
    <input type="file" id="fIn" style="display:none">

    <div class="progress-container" id="pCont"><div id="progressBar"></div></div>
    <p id="progressText">0%</p>

    <div id="status"></div>

    <textarea id="txtIn" rows="4" placeholder="Nh·∫≠p vƒÉn b·∫£n t·∫°o QR ho·∫∑c k·∫øt qu·∫£ file..."></textarea>

    <div id="qrSection">
        <img id="qrImg" src="https://via.placeholder.com/160?text=QR+CODE">
        <button class="btn-qr" onclick="dlQR()">T·∫¢I M√É QR</button>
        <p id="qrError" style="color:red; font-size:10px; margin-top:8px; display:none; text-align:center;">QR kh√¥ng h·ªó tr·ª£ n·ªôi dung qu√° d√†i!<br>Vui l√≤ng d√πng n√∫t Xu·∫•t File TXT.</p>
    </div>

    <button class="btn btn-main" onclick="openDownloadModal()">XU·∫§T FILE VƒÇN B·∫¢N (.TXT)</button>
</div>

<div id="modalName" class="overlay">
    <div class="modal-box">
        <h3>üìÇ ƒê·∫∑t t√™n file l∆∞u tr·ªØ</h3>
        <input type="text" id="fileNameInput" class="modal-input" placeholder="T√™n file..." style="margin-top:15px;">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn" onclick="closeModal()">H·ª¶Y</button>
            <button class="btn" style="background:#6c5ce7; color:white;" onclick="confirmDownload()">T·∫¢I XU·ªêNG</button>
        </div>
    </div>
</div>

<script>
    const mode = document.getElementById('mode');
    const txtIn = document.getElementById('txtIn');
    const fIn = document.getElementById('fIn');
    const urlIn = document.getElementById('urlIn');
    const pCont = document.getElementById('pCont');
    const pBar = document.getElementById('progressBar');
    const pText = document.getElementById('progressText');
    const qrImg = document.getElementById('qrImg');
    const qrError = document.getElementById('qrError');
    const loader = document.getElementById('loader');
    const status = document.getElementById('status');

    let resultData = "";
    let qrPath = "";

    // 1. X·ª¨ L√ù T·ª™ LINK (TikTok/MP3/Video)
    async function processUrl() {
        const url = urlIn.value.trim();
        if(!url) return alert("Vui l√≤ng d√°n link!");

        showLoader("üîç ƒêang tr√≠ch xu·∫•t d·ªØ li·ªáu...");
        try {
            let finalUrl = url;
            // H·ªó tr·ª£ TikTok
            if (url.includes("tiktok.com") || url.includes("douyin.com")) {
                const api = await fetch(`https://www.tikwm.com/api/?url=${encodeURIComponent(url)}`);
                const res = await api.json();
                if (res.data && res.data.play) finalUrl = res.data.play;
                else throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c link video.");
            }

            showLoader("üì• ƒêang t·∫£i file v·ªÅ b·ªô nh·ªõ t·∫°m...");
            const response = await fetch(finalUrl);
            if(!response.ok) throw new Error("Server ch·∫∑n t·∫£i tr·ª±c ti·∫øp.");
            
            const blob = await response.blob();
            processBuffer(blob, "Link_Data");
        } catch (e) {
            hideLoader();
            showStatus("‚ùå L·ªói: " + e.message, "status-error");
        }
    }

    // 2. X·ª¨ L√ù T·ª™ CH·ªåN FILE
    fIn.onchange = (e) => {
        const file = e.target.files[0];
        if (file) processBuffer(file, file.name);
    };

    // H√ÄM CHUNG: Chuy·ªÉn d·ªØ li·ªáu sang m√£ (Nh·ªã ph√¢n/Th·∫≠p ph√¢n/Base64)
    async function processBuffer(blob, name) {
        hideLoader();
        pCont.style.display = 'block';
        pText.style.display = 'block';
        
        const reader = new FileReader();
        reader.onload = async function(e) {
            const bytes = new Uint8Array(e.target.result);
            let encoded = "";
            
            if (mode.value === 'base64') {
                encoded = btoa(Array.from(bytes).map(b => String.fromCharCode(b)).join(''));
                encoded = `data:${blob.type};base64,${encoded}`;
            } else {
                for (let i = 0; i < bytes.length; i++) {
                    if (mode.value === 'binary') encoded += bytes[i].toString(2).padStart(8, '0') + " ";
                    else encoded += bytes[i].toString(10) + " ";

                    if (i % 8000 === 0) {
                        let pct = Math.round((i / bytes.length) * 100);
                        pBar.style.width = pct + "%";
                        pText.innerText = `Chuy·ªÉn ƒë·ªïi: ${pct}%`;
                        await new Promise(r => setTimeout(r, 0));
                    }
                }
            }
            
            resultData = encoded.trim();
            pBar.style.width = "100%";
            pText.innerText = "Ho√†n t·∫•t 100%!";
            txtIn.value = `[HO√ÄN T·∫§T]\nT√™n: ${name}\nDung l∆∞·ª£ng g·ªëc: ${(blob.size/1024).toFixed(2)} KB\nS·∫µn s√†ng xu·∫•t file .txt`;
            updateQRView(resultData, true);
            showStatus("‚úÖ ƒê√£ ƒë√≥ng g√≥i th√†nh c√¥ng!", "status-success");
        };
        reader.readAsArrayBuffer(blob);
    }

    // X·ª¨ L√ù VƒÇN B·∫¢N G√ï TAY (T·∫°o QR)
    txtIn.oninput = () => {
        let val = txtIn.value.trim();
        if (!val || val.startsWith("[HO√ÄN T·∫§T]")) return;
        
        let encoded = "";
        for (let i = 0; i < val.length; i++) {
            let code = val.charCodeAt(i);
            if (mode.value === 'binary') encoded += code.toString(2).padStart(8, '0') + " ";
            else if (mode.value === 'decimal') encoded += code.toString(10) + " ";
        }
        resultData = encoded || btoa(val);
        updateQRView(resultData, false);
    };

    function updateQRView(data, isFile) {
        if (data.length > 2800 || isFile) {
            qrImg.src = "https://via.placeholder.com/160?text=CH·ªà+H·ªñ+TR·ª¢+VƒÇN+B·∫¢N";
            qrError.style.display = 'block';
            qrPath = "";
        } else {
            qrError.style.display = 'none';
            qrPath = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(data)}`;
            qrImg.src = qrPath;
        }
    }

    // UI Helpers
    function showLoader(t) { document.getElementById('loaderText').innerText = t; loader.style.display = 'flex'; }
    function hideLoader() { loader.style.display = 'none'; }
    function showStatus(m, c) { status.innerText = m; status.className = c; status.style.display = 'block'; }
    function openDownloadModal() { if(!resultData) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu!"); document.getElementById('modalName').style.display = 'flex'; }
    function closeModal() { document.getElementById('modalName').style.display = 'none'; }
    function confirmDownload() {
        let n = document.getElementById('fileNameInput').value || "squirrel_data";
        const b = new Blob([resultData], {type: 'text/plain'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = n + ".txt"; a.click();
        closeModal();
    }
    async function dlQR() {
        if(!qrPath) return alert("Kh√¥ng c√≥ QR!");
        const r = await fetch(qrPath); const b = await r.blob();
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = "QR.png"; a.click();
    }
</script>
</body>
</html>
